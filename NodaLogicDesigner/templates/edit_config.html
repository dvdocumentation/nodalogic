{% extends "base.html" %}

{% block content %}
<div class="container mt-4" data-config-uid="{{ config.uid }}">
   
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mb-3">← {{ _('Home') }}</a>

    <h2>{{ _('Edit configuration') }}</h2>


    
    {% set active_tab = request.args.get('tab', 'config') %}
    {% set active_subtab = request.args.get('subtab', '') %}

    {% if request.args.get("error") %}
<script>
    alert("{{ request.args.get('error')|tojson }}");
</script>
{% endif %}

    <div class="row">
        
        <!-- Side tabs -->
        <div class="col-md-3">
            <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link {% if active_tab == 'config' %}active{% endif %}" 
                        id="v-pills-config-tab" data-bs-toggle="pill" data-bs-target="#v-pills-config" type="button" role="tab">
                    {{ _('Configurations') }}
                </button>

                <button class="nav-link {% if active_tab == 'ai-generator' %}active{% endif %}" 
                        id="v-pills-ai-generator-tab" data-bs-toggle="pill" data-bs-target="#v-pills-ai-generator" type="button" role="tab">
                    {{ _('AI Generator') }}
                </button>

                <button class="nav-link {% if active_tab == 'classes' %}active{% endif %}" 
                        id="v-pills-classes-tab" data-bs-toggle="pill" data-bs-target="#v-pills-classes" type="button" role="tab">
                    {{ _('Classes') }}
                </button>

                <button class="nav-link {% if active_tab == 'handlers' %}active{% endif %}" 
                        id="v-pills-handlers-tab" data-bs-toggle="pill" data-bs-target="#v-pills-handlers" type="button" role="tab">
                    {{ _('Android/Python handlers') }}
                </button>

                <button class="nav-link {% if active_tab == 'handlers-server' %}active{% endif %}" 
                        id="v-pills-handlers-server-tab" data-bs-toggle="pill" data-bs-target="#v-pills-handlers-server" type="button" role="tab">
                    {{ _('Server/Python handlers') }}
                </button>
                <button class="nav-link {% if active_tab == 'datasets' %}active{% endif %}" 
                    id="v-pills-datasets-tab" data-bs-toggle="pill" data-bs-target="#v-pills-datasets" type="button" role="tab">
                {{ _('Datasets') }}
            </button>
            <button class="nav-link {% if active_tab == 'servers' %}active{% endif %}" 
                    id="v-pills-servers-tab" data-bs-toggle="pill" 
                    data-bs-target="#v-pills-servers" type="button" role="tab">
                {{ _('Servers') }}
            </button>
            <button class="nav-link {% if active_tab == 'common-events' %}active{% endif %}" 
                id="v-pills-common-events-tab" data-bs-toggle="pill" data-bs-target="#v-pills-common-events" type="button" role="tab">
            {{ _('Common events') }}
        </button>
            </div>
        </div>
        
        <!-- Tab content -->
        <div class="col-md-9">
            <div class="tab-content" id="v-pills-tabContent">

                <div class="tab-pane fade {% if active_tab == 'ai-generator' %}show active{% endif %}" 
                    id="v-pills-ai-generator" role="tabpanel">

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">AI configuration generator</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                Enter a request, and LLM will modify the current configuration (classes, events, handlers, etc.), 
                                adding new objects and applying the necessary changes.
                            </p>

                            <form id="aiGeneratorForm">
                                <div class="mb-3">
                                    <label for="aiProvider" class="form-label">LLM</label>
                                    <select class="form-select" id="aiProvider">
                                        <option value="deepseek">DeepSeek (cloud)</option>
                                        <option value="lmstudio">LM Studio (local)</option>
                                    </select>
                                    <div class="form-text">
                                        For LM Studio: Run local server (usually http://127.0.0.1:1234) and select model in LM Studio.
                                    </div>
                                </div>    

                                <div class="mb-3">
                                    <label for="aiPrompt" class="form-label">Prompt for LLM</label>
                                    <textarea class="form-control" id="aiPrompt" rows="6"
                                            placeholder="For example: 'Add an Order class with the fields Order Date, Buyer (dataset), and comment (multi-line text) with the table section Product (string), Quantity, Price, Amount'"></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary" id="aiGenerateBtn">
                                    <i class="bi bi-magic"></i> Run the AI ​​generator
                                </button>

                                <button type="button" class="btn btn-outline-secondary ms-2" id="aiGenerateLayoutBtn">
                                <i class="bi bi-braces"></i> Сгенерировать только разметку
                                </button>

                                <div class="mt-3">
                                <label for="aiLayoutOutput" class="form-label mb-1">JSON разметки (layout)</label>
                                <textarea class="form-control" id="aiLayoutOutput" rows="10" spellcheck="false"
                                            placeholder='[[{"type":"Text","text":"..."}], [{"type":"Input","code":"field"}]]'></textarea>
                                
                                </div>
                            </form>

                            <div class="mt-3">
                                <div id="aiGeneratorStatus" class="small text-muted"></div>
                                <pre id="aiGeneratorError" class="mt-2 text-danger" style="white-space: pre-wrap; display:none;"></pre>
                            </div>
                        </div>
                    </div>
                </div>    

                <!-- Tab "Configuration" -->
                <div class="tab-pane fade show {% if active_tab == 'config' %}show active{% endif %}" id="v-pills-config" role="tabpanel">
                    
                        <!-- General settings -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>{{ _('General settings') }}</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-start">
                <!-- Left side -->
                <div class="col-md-3 text-center">
                    {% set api_url = '' %}
                    <div class="mb-2" style="min-height: 150px; display: flex; justify-content: center; align-items: center;">
                        <canvas id="qrcodeCanvas" width="150" height="150"></canvas>
                    </div>
                    <small class="text-muted">{{ _('Configuration API QR-code') }}</small>

                    <input type="hidden" id="apiUrl" value="{{ api_url }}">
                </div>
                
                <!-- R. side -->
                <div class="col-md-9">
                    <form method="POST" action="{{ url_for('update_config', uid=config.uid) }}">
                        <input type="hidden" name="active_tab" id="activeTabField">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="configName" class="form-label">{{ _('Configuration name') }}</label>
                                <input type="text" class="form-control" id="configName" name="name" value="{{ config.name }}" required>
                            </div>
                            <div class="col-md-3">
                                <label for="configVersion" class="form-label">{{ _('Version') }}</label>
                                <input type="text" class="form-control" id="configVersion" name="version" value="{{ config.version }}" required>
                            </div>

                            <div class="col-md-3">
                                <label for="serverName" class="form-label">{{ _('*Server name?') }}</label>
                                <input type="text" class="form-control" id="serverName" name="server_name" value="{{ config.server_name }}">
                            </div>
                                                        
                           <div class="col-md-6">
                                <label for="configProvider" class="form-label">{{ _('Vendor') }}</label>
                                <input type="text" class="form-control" id="configProvider" name="provider" 
                                    value="{{ config.vendor }}" readonly>
                            </div>

                            <div class="col-md-6">
                                <label for="contentUid" class="form-label">{{ _('Content UID') }}</label>
                                <input type="text" class="form-control" id="contentUid" value="{{ config.content_uid }}" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">{{ _('Last modified') }}</label>
                                <input type="text" class="form-control" value="{{ format_datetime(config.last_modified, format='medium') }}" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">{{ _('Save') }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

                    <!--Import/Export -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>{{ _('Configuration uploading/downdloading') }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>{{ _('Configuration download') }}</h6>
                                    <p>{{ _('Download the full configuration in JSON format') }}</p>
                                    <a href="{{ url_for('export_config', uid=config.uid) }}" class="btn btn-primary">
                                        <i class="bi bi-download"></i> {{ _('Download configuration') }}
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <h6>{{ _('Configuration uploading') }}</h6>
                                    <p>{{ _('Load configuration from JSON file (existing data will be overwritten)') }}</p>
                                    <form method="POST" action="{{ url_for('import_config', uid=config.uid) }}" enctype="multipart/form-data">
                                        <input type="hidden" name="active_tab" id="activeTabImport">
                                        <div class="mb-3">
                                            <input class="form-control" type="file" name="config_file" accept=".nod" required>
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="bi bi-upload"></i> {{ _('Upload configuration') }}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sections -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _('Sections') }}</h5>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#sectionModal">
                                {{ _('Add section') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>{{ _('ID') }}</th>
                                        <th>{{ _('Title') }}</th>
                                        <th>{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for section in config.sections %}
                                    <tr>
                                        <td>{{ section.code }}</td>
                                        <td>{{ section.name }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-section-btn" 
                                                    data-section-id="{{ section.id }}">
                                                {{ _('Edit') }}
                                            </button>
                                            <a href="{{ url_for('delete_section', section_id=section.id) }}" 
                                            class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Delete section {{ section.name }}?')">
                                                {{ _('Delete') }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Classes tab -->
                <div class="tab-pane fade  {% if active_tab == 'classes' %}show active{% endif %}" id="v-pills-classes" role="tabpanel">
                    <div class="card">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> {{ _('Add class') }}</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('create_class', config_uid=config.uid) }}">
                                    <input type="hidden" name="active_tab" id="activeTabField">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="newClassName" class="form-label">{{ _('Class name') }}</label>
                                                <input type="text" class="form-control" id="newClassName" name="name" 
                                                    pattern="[a-zA-Z_][a-zA-Z0-9_]*" 
                                                    title="{{ _('A class name must begin with a letter or underscore and contain only letters, numbers, and underscores.') }}"
                                                    required>
                                                <small class="text-muted">{{ _('Used to create a class in Python') }}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="bi bi-plus-circle"></i> {{ _('Create class') }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>{{ _('Name') }}</th>
                                        <th>{{ _('Methods count') }}</th>
                                        <th>{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for class_obj in config.classes %}
                                    <tr>
                                        <td>{{ class_obj.name }}</td>
                                        <td>{{ class_obj.methods|length }}</td>
                                        <td>
                                            <a href="{{ url_for('edit_class', class_id=class_obj.id) }}" class="btn btn-sm btn-outline-primary me-2">
                                                {{ _('Edit') }}
                                            </a>
                                            <a href="{{ url_for('delete_class', class_id=class_obj.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete class {{ class_obj.name }}?')">
                                                {{ _('Delete') }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab "Handlers" -->
                <div class="tab-pane fade {% if active_tab == 'handlers' %}show active{% endif %}" id="v-pills-handlers" role="tabpanel">
                    <ul class="nav nav-tabs mb-4" id="handlersTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if active_subtab != 'code' %}active{% endif %}" id="handlers-upload-tab" data-bs-toggle="tab" data-bs-target="#handlers-upload" type="button" role="tab">{{ _('Handlers upload') }}</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if active_subtab == 'code' %}active{% endif %}" id="handlers-code-tab" data-bs-toggle="tab" data-bs-target="#handlers-code" type="button" role="tab">{{ _('Code editor') }}</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- "Uppload handlers" -->
                        <div class="tab-pane fade show {% if active_subtab != 'code' %}active{% endif %}" id="handlers-upload" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>{{ _('Upload handlers') }}</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="uploadMethodTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#fileUpload" type="button" role="tab">{{ _('Upload py-file') }}</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="github-tab" data-bs-toggle="tab" data-bs-target="#githubUpload" type="button" role="tab">{{ _('GitHub link') }}</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3" id="uploadMethodTabContent">
                                        <div class="tab-pane fade show active" id="fileUpload" role="tabpanel">
                                            <form method="POST" action="{{ url_for('upload_handlers', uid=config.uid) }}" enctype="multipart/form-data">
                                                <input type="hidden" name="upload_type" value="file">
                                                <input type="hidden" name="active_tab" id="activeTabUpload">
                                                <div class="mb-3">
                                                    <label for="pythonFile" class="form-label">{{ _('Select py-file :') }}</label>
                                                    <input class="form-control" type="file" id="pythonFile" name="python_file" accept=".py" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">{{ _('Upload') }}</button>
                                            </form>
                                        </div>
                                        <div class="tab-pane fade" id="githubUpload" role="tabpanel">
                                            <form method="POST" action="{{ url_for('upload_handlers', uid=config.uid) }}">
                                                <input type="hidden" name="upload_type" value="github">
                                                <div class="mb-3">
                                                    <label for="githubUrl" class="form-label">{{ _('GitHub raw URL:') }}</label>
                                                    <input type="url" class="form-control" id="githubUrl" name="github_url" placeholder="https://raw.githubusercontent.com/user/repo/branch/file.py" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">{{ _('Upload') }}</button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    {% if config.nodes_handlers %}
                                        <div class="mt-3">
                                            <a href="{{ url_for('download_handlers', uid=config.uid) }}" class="btn btn-outline-primary me-2">
                                                <i class="bi bi-download"></i> {{ _('Download file') }}
                                            </a>
                                            <form method="POST" action="{{ url_for('clear_handlers', uid=config.uid) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete handlers code?')">
                                                    <i class="bi bi-trash"></i> {{ _('Delete handlers code') }}
                                                </button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Handlers code tab -->
                        <div class="tab-pane fade {% if active_subtab == 'code' %}show active{% endif %}" id="handlers-code" role="tabpanel">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">{{ _('Edit handlers code') }}</h5>
                                    <button type="button" class="btn btn-primary" id="saveHandlersBtn">
                                        <i class="bi bi-save"></i> {{ _('Save') }}
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    {% if config.nodes_handlers %}
                                        <code-input name="handlers_code" id="handlersCodeInput" language="Python">{{ config.nodes_handlers|b64decode }}</code-input>
                                    {% else %}
                                        <div class="alert alert-info m-3">
                                            <i class="bi bi-info-circle"></i> {{ _('No handlers code added') }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--  Server/Python -->
                <div class="tab-pane fade {% if active_tab == 'handlers-server' %}show active{% endif %}" id="v-pills-handlers-server" role="tabpanel">
                    <ul class="nav nav-tabs mb-4" id="serverHandlersTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if active_subtab != 'code' %}active{% endif %}" id="server-handlers-upload-tab" data-bs-toggle="tab" data-bs-target="#server-handlers-upload" type="button" role="tab">{{ _('Handlers upload') }}</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if active_subtab == 'code' %}active{% endif %}" id="server-handlers-code-tab" data-bs-toggle="tab" data-bs-target="#server-handlers-code" type="button" role="tab">{{ _('Code editor') }}</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!--  "Upload handlers code" -->
                        <div class="tab-pane fade show {% if active_subtab != 'code' %}show active{% endif %}" id="server-handlers-upload" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>{{ _('Upload handlers code') }}</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="serverUploadMethodTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="server-file-tab" data-bs-toggle="tab" data-bs-target="#server-fileUpload" type="button" role="tab">{{ _('Upload file') }}</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="server-github-tab" data-bs-toggle="tab" data-bs-target="#server-githubUpload" type="button" role="tab">{{ _('GitHab link') }}</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3" id="serverUploadMethodTabContent">
                                        <div class="tab-pane fade show active" id="server-fileUpload" role="tabpanel">
                                            <form method="POST" action="{{ url_for('upload_server_handlers', uid=config.uid) }}" enctype="multipart/form-data">
                                                <input type="hidden" name="upload_type" value="file">
                                                <div class="mb-3">
                                                    <label for="serverPythonFile" class="form-label">{{ _('Select py-file') }}</label>
                                                    <input class="form-control" type="file" id="serverPythonFile" name="python_file" accept=".py" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">{{ _('Upload') }}</button>
                                            </form>
                                        </div>
                                        <div class="tab-pane fade" id="server-githubUpload" role="tabpanel">
                                            <form method="POST" action="{{ url_for('upload_server_handlers', uid=config.uid) }}">
                                                <input type="hidden" name="upload_type" value="github">
                                                <div class="mb-3">
                                                    <label for="serverGithubUrl" class="form-label">{{ _('GitHub raw URL:') }}</label>
                                                    <input type="url" class="form-control" id="serverGithubUrl" name="github_url" placeholder="https://raw.githubusercontent.com/user/repo/branch/file.py" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">{{ _('Upload') }}</button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    {% if config.nodes_server_handlers %}
                                        <div class="mt-3">
                                            <a href="{{ url_for('download_server_handlers', uid=config.uid) }}" class="btn btn-outline-primary me-2">
                                             <input type="hidden" name="active_tab" id="activeTabField"> 
                                                <i class="bi bi-download"></i> {{ _('Download file') }}
                                            </a>
                                            <form method="POST" action="{{ url_for('clear_server_handlers', uid=config.uid) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete server handlers code?')">
                                                    <i class="bi bi-trash"></i> {{ _('Delete') }}
                                                </button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Server handlers code -->
                        <div class="tab-pane fade {% if active_subtab == 'code' %}show active{% endif %}" id="server-handlers-code" role="tabpanel">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">{{ _('Server handlers code editior') }}</h5>
                                    <button type="button" class="btn btn-primary" id="saveServerHandlersBtn">
                                        <i class="bi bi-save"></i> {{ _('Save') }}
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    {% if config.nodes_server_handlers %}
                                        <code-input name="server_handlers_code" id="serverHandlersCodeInput" language="Python">{{ config.nodes_server_handlers|b64decode }}</code-input>
                                    {% else %}
                                        <div class="alert alert-info m-3">
                                            <i class="bi bi-info-circle"></i> {{ _('No added handlers') }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datasets -->
                <div class="tab-pane fade {% if active_tab == 'datasets' %}show active{% endif %}" id="v-pills-datasets" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _('Datasets') }}</h5>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#datasetModal">
                                {{ _('Add dataset') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>{{ _('Dataset name') }}</th>
                                        <th>{{ _('Hash-indexes') }}</th>
                                        <th>{{ _('Text-indexes') }}</th>
                                        <th>{{ _('Records count') }}</th>
                                        <th>{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dataset in config.datasets %}
                                    <tr>
                                        <td>{{ dataset.name }}</td>
                                        <td>{{ dataset.hash_indexes }}</td>
                                        <td>{{ dataset.text_indexes }}</td>
                                        <td>{{ dataset.items|length }}</td>
                                        <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-dataset-btn" 
                                                data-dataset-id="{{ dataset.id }}">
                                            {{ _('Edit') }}
                                        </button>
                                        <a href="{{ url_for('delete_dataset', dataset_id=dataset.id) }}" 
                                        class="btn btn-sm btn-outline-danger" 
                                        onclick="return confirm('Delete dataset {{ dataset.name }}?')">
                                            {{ _('Delete') }}
                                        </a>
                                    </td>
                                                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="mt-4">
                                <h5>{{ _('API for working with datasets') }}</h5>
                               <div class="card bg-light">
                                        <div class="card-body">
                                            <h6>{{ _('Adding/updating records') }}</h6>
                                            <pre class="mb-3"><code>POST <span class="api-url-base"></span>/dataset/&lt;dataset_name&gt;/items
                                    Content-Type: application/json

                                    [
                                        {"_id": "1", "field1": "value1", "field2": "value2"},
                                        {"_id": "2", "field1": "value3", "field2": "value4"}
                                    ]</code></pre>

                                            <h6>{{ _('Getting all records') }}</h6>
                                            <pre><code>GET <span class="api-url-base"></span>/dataset/&lt;dataset_name&gt;/items</code></pre>

                                            <h6>{{ _('Delete all records') }}</h6>
                                            <pre><code>DELETE <span class="api-url-base"></span>/dataset/&lt;dataset_name&gt;/items</code></pre>

                                            <h6>{{ _('Delete one record') }}</h6>
                                            <pre><code>DELETE <span class="api-url-base"></span>/dataset/&lt;dataset_name&gt;/items/item_id</code></pre>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade {% if active_tab == 'servers' %}show active{% endif %}" 
                    id="v-pills-servers" role="tabpanel">

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ _('Servers') }}</h5>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#serverModal">
                               {{ _('Add server') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>{{ _('Alias') }}</th>
                                        <th>URL</th>
                                        <th>{{ _('By default') }}</th>
                                        <th>{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for server in config.servers %}
                                    <tr>
                                        <td>{{ server.alias }}</td>
                                        <td>{{ server.url }}</td>
                                        <td>{% if server.is_default %}✔{% endif %}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-server-btn"
                                                    data-server-id="{{ server.id }}">
                                                {{ _('Edit') }}
                                            </button>
                                            <a href="{{ url_for('delete_server', server_id=server.id) }}" 
                                            class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Delete server {{ server.alias }}?')">
                                                {{ _('Delete') }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab "Common Events" -->
<div class="tab-pane fade {% if active_tab == 'common-events' %}show active{% endif %}" id="v-pills-common-events" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ _('Common events') }}</h5>
            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#commonEventModal">
                {{ _('Add common event') }}
            </button>
        </div>
        <div class="card-body">
            {% if config.config_events %}
            <table class="table">
                <thead>
                    <tr>
                        <th>{{ _('Event') }}</th>
                        <th>{{ _('Listener') }}</th>
                        <th>{{ _('Actions') }}</th>
                        <th class="text-end">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in config.config_events %}
                    <tr>
                        <td>
                            <span class="badge event-badge event-{{ event.event|lower }}">{{ event.event }}</span>
                        </td>
                        <td>{{ event.listener }}</td>
                        <td>
                            {% for action in event.actions %}
                                <div>
                                    <strong>{{ action.method }}</strong>
                                    <small class="text-muted"> ({{ action.action }}{% if action.post_execute_method %} → post: {{ action.post_execute_method }}{% endif %})</small>
                                </div>
                            {% endfor %}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2 edit-common-event-btn"
                                    data-bs-toggle="modal" data-bs-target="#commonEventModal"
                                    data-event-id="{{ event.id }}"
                                    data-event-name="{{ event.event }}"
                                    data-listener-name="{{ event.listener }}"
                                    data-actions='{{ event.actions_as_dicts() | tojson | safe }}'>
                                <i class="bi bi-pencil"></i> {{ _('Edit') }}
                            </button>
                            <form method="POST" action="{{ url_for('delete_config_event', config_uid=config.uid) }}" style="display:inline;">
                                <input type="hidden" name="event_name" value="{{ event.event }}">
                                <input type="hidden" name="listener" value="{{ event.listener }}">
                                <button type="button" class="btn btn-sm btn-outline-danger delete-common-event-btn"
                                        data-event-name="{{ event.event }}"
                                        data-listener="{{ event.listener }}">
                                    <i class="bi bi-trash"></i> {{ _('Delete') }}
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> {{ _('No common events added') }}
            </div>
            {% endif %}
        </div>
    </div>
</div>


            </div>
        </div>
    </div>
</div>


<!-- Common Events Modal -->
<div class="modal fade" id="commonEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commonEventModalTitle">{{ _('Add common event') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" id="commonEventForm">
        <input type="hidden" name="old_event_name" id="oldCommonEventName">
        <input type="hidden" name="old_listener" id="oldCommonListener">
        <input type="hidden" name="actions_json" id="commonActionsJson">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ _('Event type') }}</label>
            <select class="form-select" name="event_name" id="commonEventNameSelect" required>
              <option value="onLaunch">onLaunch</option>
              <option value="onBarcode">onBarcode</option>
              <option value="onStartMenuCommand">onStartMenuCommand</option>
              <option value="onTimer">onTimer</option>
              <option value="onDialogResult">onDialogResult</option>
              <option value="onJSONFile">onJSONFile</option>
              <option value="onTextFile">onTextFile</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Listener') }}</label>
            <input type="text" class="form-control" name="listener" id="commonListenerInput" placeholder="{{ _('Listener name (optional)') }}">
          </div>

          <hr>
          <h6>{{ _('Actions') }}</h6>
          <div id="commonActionsContainer"></div>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addCommonActionBtn">
              <i class="bi bi-plus-circle"></i> {{ _('Add action') }}
            </button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary" id="saveCommonEventBtn">{{ _('Save') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!--Servers modal-->
<div class="modal fade" id="serverModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('create_server', config_uid=config.uid) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ _('Add server') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="active_tab" value="servers">
          <div class="mb-3">
            <label class="form-label">{{ _('Alias') }}</label>
            <input type="text" class="form-control" name="alias" required>
          </div>
          <div class="mb-3">
            <label class="form-label">URL</label>

            <input type="url" class="form-control" name="url" id="serverUrlInput" required>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" name="is_default" id="isDefault">
            <label class="form-check-label" for="isDefault">{{ _('By default') }}</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Sections modal -->
<div class="modal fade" id="sectionModal" tabindex="-1" aria-labelledby="sectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionModalTitle">{{ _('Add section') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sectionForm" method="POST">
                <input type="hidden" id="section_id" name="section_id">
                <input type="hidden" name="active_tab" id="activeTabField">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sectionCode" class="form-label">{{ _('ID') }}</label>
                        <input type="text" class="form-control" id="sectionCode" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label for="sectionName" class="form-label">{{ _('Name') }}</label>
                        <input type="text" class="form-control" id="sectionName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="sectionCommands" class="form-label">{{ _('Commands') }}</label>
                        <textarea class="form-control" id="sectionCommands" name="commands" rows="4" 
                                  placeholder="{{ _('Enter commands in the format Title|Variable') }}"></textarea>
                        <div class="form-text">{{ _('Enter commands in the format Title|Variable') }}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Dataset modal -->
<div class="modal fade" id="datasetModal" tabindex="-1" aria-labelledby="datasetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetModalTitle">{{ _('Add dataset') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="datasetForm" method="POST">
                
                <input type="hidden" id="dataset_id" name="dataset_id">
                
                <input type="hidden" name="active_tab" id="datasetActiveTab">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">{{ _('Dataset name') }}</label>
                        <input type="text" class="form-control" id="datasetName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="hashIndexes" class="form-label">{{ _('Hash-indexes') }}</label>
                        <input type="text" class="form-control" id="hashIndexes" name="hash_indexes" placeholder="field1,field2">
                        <div class="form-text">{{ _('Fields for exact search separated by commas') }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="textIndexes" class="form-label">{{ _('Text-indexes') }}</label>
                        <input type="text" class="form-control" id="textIndexes" name="text_indexes" placeholder="field3,field4">
                        <div class="form-text">{{ _('Full-text search fields (comma separated)') }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="viewTemplate" class="form-label">{{ _('Record template') }}</label>
                        <textarea class="form-control" id="viewTemplate" name="view_template" rows="3"></textarea>
                        <div class="form-text">{{ _('HTML template for displaying dataset element in input fields. For example: {name} , {_id}') }}</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="autoload" name="autoload">
                        <label class="form-check-label" for="autoload">{{ _('Autoload?*') }}</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Import Prism.js-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
<!--Import code-input-->
<script src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.3/code-input.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.3/code-input.min.css">

<!--Import some code-input plugins-->
<script src="https://cdn.jsdelivr.net/gh/WebCoder49/code-input@2.3/plugins/indent.min.js"></script>

<!--Register code-input template-->
<script>
  codeInput.registerTemplate("syntax-highlighted", 
    codeInput.templates.prism(
      Prism, 
      [
        new codeInput.plugins.Indent(true, 2)
      ]
    )
  );
</script>

<style>

#v-pills-tabContent {
    min-height: 600px;
}


#v-pills-handlers .code-input-editor,
#v-pills-handlers-server .code-input-editor {
    min-height: 500px !important;
    height: 500px !important;
}


#v-pills-handlers code-input,
#v-pills-handlers-server code-input {
    height: 500px !important;
}


.modal-lg .code-input-editor {
    min-height: 400px !important;
    height: 400px !important;
}
    
.code-input {
  width: calc(100% - 40px);
  margin: 20px;
  --padding: 20px;
}

.code-input-editor {
    min-height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
}

code-input {
    --code-input-color: #333;
    --code-input-background: #f8f9fa;
    --code-input-border-color: #dee2e6;
    --code-input-border-radius: 4px;
    --code-input-padding: 10px;
}

.modal-lg .code-input-editor {
    min-height: 300px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

    codeInput.registerTemplate("syntax-highlighted", 
        codeInput.templates.prism(
            Prism, 
            [new codeInput.plugins.Indent(true, 2)]
        )
    );

    const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.id.replace('-tab', '');
            const tabName = tabId.replace('v-pills-', '');
            

            document.querySelectorAll('input[name="active_tab"]').forEach(input => {
                input.value = tabName;
            });
            

            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.replaceState({}, '', url);
        });
    });


    

    const currentTab = new URLSearchParams(window.location.search).get('tab') || 'config';
    document.querySelectorAll('input[name="active_tab"]').forEach(input => {
        input.value = currentTab;
    });
    

    document.getElementById('saveHandlersBtn').addEventListener('click', function() {
    const editor = document.getElementById('handlersCodeInput');
    const formData = new FormData();
    formData.append('handlers_code', editor.value);
    formData.append('active_tab', 'handlers');
    formData.append('active_subtab', 'code');
    
    fetch("{{ url_for('update_handlers_code', uid=config.uid) }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "error") {
           
            alert(data.message);
        } else {
            window.location.href = "{{ url_for('edit_config', uid=config.uid) }}?tab=handlers&subtab=code";
        }
    })
    .catch(error => alert('Error: ' + error));
});


    document.getElementById('saveServerHandlersBtn').addEventListener('click', function() {
    const editor = document.getElementById('serverHandlersCodeInput');
    const formData = new FormData();
    formData.append('handlers_code', editor.value);
    formData.append('active_tab', 'handlers-server');
    formData.append('active_subtab', 'code');
    
    fetch("{{ url_for('update_server_handlers_code', uid=config.uid) }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "error") {
            alert(data.message);
        } else {
            window.location.href = "{{ url_for('edit_config', uid=config.uid) }}?tab=handlers-server&subtab=code";
        }
    })
    .catch(error => alert('Error: ' + error));
});


    const datasetModal = new bootstrap.Modal(document.getElementById('datasetModal'));
    const datasetForm = document.getElementById('datasetForm');
    const modalTitle = document.getElementById('datasetModalTitle');

    document.querySelector('[data-bs-target="#datasetModal"]').addEventListener('click', function() {
        modalTitle.textContent = "{{ _('Add dataset') }}";
        datasetForm.reset();
        document.getElementById('dataset_id').value = '';
        datasetForm.action = "{{ url_for('add_dataset', config_uid=config.uid) }}";
    });

    document.querySelectorAll('.edit-dataset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const datasetId = this.getAttribute('data-dataset-id');
            
            fetch(`/get-dataset-json?dataset_id=${datasetId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error dataset data loading');
                    return response.json();
                })
                .then(data => {
                    modalTitle.textContent = "{{ _('Edit dataset') }}";
                    document.getElementById('dataset_id').value = datasetId;
                    document.getElementById('datasetName').value = data.name || '';
                    document.getElementById('hashIndexes').value = data.hash_indexes || '';
                    document.getElementById('textIndexes').value = data.text_indexes || '';
                    document.getElementById('viewTemplate').value = data.view_template || '';
                    document.getElementById('autoload').checked = data.autoload || false;
                    
                    datasetForm.action = "{{ url_for('update_dataset', dataset_id='') }}" + datasetId;
                    datasetModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load dataset data: ' + error.message);
                });
        });
    });

    datasetForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const currentTab = new URLSearchParams(window.location.search).get('tab') || 'datasets';
    formData.append('active_tab', currentTab);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        if (response.status === 401) {
            window.location.href = "{{ url_for('index') }}";
            return;
        }
        
        const data = await response.json();
        if (data.status === "success") {

            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {

                window.location.href = "{{ url_for('edit_config', uid=config.uid) }}?tab=" + currentTab;
            }
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Request failed: ' + error.message);
    });
});


  


    const sectionModal = new bootstrap.Modal(document.getElementById('sectionModal'));
    const sectionForm = document.getElementById('sectionForm');
    const sectionModalTitle = document.getElementById('sectionModalTitle');

    document.querySelector('[data-bs-target="#sectionModal"]').addEventListener('click', function() {
        sectionModalTitle.textContent = "{{ _('Add section') }}";
        sectionForm.reset();
        document.getElementById('section_id').value = '';
        sectionForm.action = "{{ url_for('add_section', config_uid=config.uid) }}";
    });

    document.querySelectorAll('.edit-section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const sectionId = this.getAttribute('data-section-id');
        const sectionRow = this.closest('tr');
        

        fetch(`/get-section-json?section_id=${sectionId}`)
            .then(response => {
                if (!response.ok) throw new Error('Error sections loading');
                return response.json();
            })
            .then(data => {
                sectionModalTitle.textContent = "{{ _('Edit section') }}";
                document.getElementById('section_id').value = sectionId;
                document.getElementById('sectionCode').value = data.code || '';
                document.getElementById('sectionName').value = data.name || '';
                document.getElementById('sectionCommands').value = data.commands || '';
                
                sectionForm.action = "{{ url_for('update_section', section_id='') }}" + sectionId;
                sectionModal.show();
            })
            .catch(error => {
                console.error('Error:', error);

                sectionModalTitle.textContent = "{{ _('Edit section') }}";
                document.getElementById('section_id').value = sectionId;
                document.getElementById('sectionCode').value = sectionRow.cells[0].textContent;
                document.getElementById('sectionName').value = sectionRow.cells[1].textContent;
                document.getElementById('sectionCommands').value = '';
                
                sectionForm.action = "{{ url_for('update_section', section_id='') }}" + sectionId;
                sectionModal.show();
            });
    });
    });

    sectionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>    



<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    const currentProtocol = window.location.protocol;
    const currentHost = window.location.host;
    const apiPath = "{{ url_for('get_config', uid=config.uid, _external=False) }}";
    const apiUrl = currentProtocol + '//' + currentHost + apiPath;
    const canvas = document.getElementById('qrcodeCanvas');

     const baseUrl = window.location.protocol + "//" + window.location.host + "{{ url_for('get_config', uid=config.uid, _external=False) }}";
    

    document.getElementById('apiUrl').value = baseUrl;
    

    document.querySelectorAll('.api-url-base').forEach(el => {
        el.textContent = baseUrl;
    });

   
    QRCode.toCanvas(canvas, apiUrl, {
        width: 150,
        height: 150,
        margin: 1,
        color: {
            dark: '#000000',
            light: '#ffffff'
        }
    }, function(error) {
        if (error) {
            console.error('QR code generation error:', error);
    
            canvas.getContext('2d').fillText('QR Error', 10, 10);
        }
    });
});

function copyApiUrl() {
    const apiUrl = document.getElementById('apiUrl').value;
    navigator.clipboard.writeText(apiUrl).then(() => {
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> copied!';
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);

        const tempInput = document.createElement('input');
        tempInput.value = apiUrl;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> copied!';
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    });
}

function initializeActiveTabs() {
    const currentTab = new URLSearchParams(window.location.search).get('tab') || 'config';
    

    document.querySelectorAll('input[name="active_tab"]').forEach(input => {
        input.value = currentTab;
    });
    

    document.querySelectorAll('[id^="activeTab"]').forEach(element => {
        element.value = currentTab;
    });
}

document.addEventListener('DOMContentLoaded', initializeActiveTabs);

document.addEventListener('DOMContentLoaded', function() {
    const currentTab = new URLSearchParams(window.location.search).get('tab') || 'datasets';
    document.getElementById('datasetActiveTab').value = currentTab;
});



document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('[data-config-uid]');
  if (!container) return;
    const configUid = container.dataset.configUid;

    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1';
    const currentProtocol = window.location.protocol;
    const defaultUrl = `${currentProtocol}//${window.location.host}`;
    
   
    document.getElementById('serverUrlInput').value = defaultUrl;



  const serverModalEl = document.getElementById('serverModal');
  let serverModal;
  if (serverModalEl) serverModal = new bootstrap.Modal(serverModalEl);


  function openServerModal({ id, alias, url, is_default }) {
    if (!serverModalEl) {
      console.warn('serverModal not found');
      return;
    }


    if (!id) {
      alert('Not allow editing');
      return;
    }

    document.getElementById('server_id').value = id;
    document.getElementById('serverAlias').value = alias || '';
    document.getElementById('serverUrl').value = url || '';
    document.getElementById('serverIsDefault').checked = !!is_default;

    serverModal.show();
  }


  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.edit-server-btn');
    if (!btn) return;


    const id = btn.dataset.serverId || btn.getAttribute('data-server-id') || null;
    const alias = btn.dataset.serverAlias || btn.getAttribute('data-server-alias') || null;
    const url = btn.dataset.serverUrl || btn.getAttribute('data-server-url') || null;
    const is_default = btn.dataset.serverDefault === '1' || btn.dataset.serverDefault === 'true';


    if (!alias || !url) {
      const tr = btn.closest('tr');
      if (tr) {
        alias = alias || (tr.querySelector('.server-alias') && tr.querySelector('.server-alias').textContent.trim());
        url = url || (tr.querySelector('.server-url') && tr.querySelector('.server-url').textContent.trim());
      }
    }

    openServerModal({ id, alias, url, is_default });
  });


  const serverForm = document.getElementById('serverForm');
  if (!serverForm) {
    console.warn('serverForm not found');
    return;
  }

  serverForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('server_id').value || '';
    const payload = {
      alias: document.getElementById('serverAlias').value.trim(),
      url: document.getElementById('serverUrl').value.trim(),
      is_default: document.getElementById('serverIsDefault').checked
    };


    if (!payload.alias || !payload.url) {
      alert("{{ _('Put alias and ULR') }}");
      return;
    }

    const method = id ? 'PUT' : 'POST';
    const endpoint = id
      ? `/api/config/${configUid}/servers/${id}`
      : `/api/config/${configUid}/servers`;

    fetch(endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || err.message || `HTTP ${res.status}`);
      }
      return res.json();
    })
    .then(data => {

      window.location.reload();
    })
    .catch(err => {
      console.error(err);
      alert('Error: ' + err.message);
    });
  });
});

// Common Events functionality

document.addEventListener('DOMContentLoaded', function() {
    // Handling a click on the delete button
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-common-event-btn')) {
            const btn = e.target.closest('.delete-common-event-btn');
            const eventName = btn.getAttribute('data-event-name');
            const listener = btn.getAttribute('data-listener');
            
            if (confirm('Delete this event?')) {
                deleteCommonEvent(eventName, listener);
            }
        }
    });
    
    function deleteCommonEvent(eventName, listener) {
        const configUid = document.querySelector('[data-config-uid]').dataset.configUid;
        const activeTab = new URLSearchParams(window.location.search).get('tab') || 'common-events';
        
        const formData = new FormData();
        formData.append('event_name', eventName);
        formData.append('listener', listener);
        formData.append('active_tab', activeTab);
        
        fetch(`/config/${configUid}/delete-event`, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(async response => {
            if (response.status === 401) {
                window.location.href = "{{ url_for('index') }}";
                return;
            }
            
            const data = await response.json();
            if (data.status === "success") {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.reload();
                }
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Request failed: ' + error.message);
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
  const COMMON_EVENT_TYPES = ['onLaunch', 'onBarcode', 'onStartMenuCommand', 'onTimer', 'onDialogResult','onJSONFile','onTextFile'];
  const ACTION_TYPES = ['run','runprogress','runasync'];

 
    
    // Make sure the active tab is passed correctly
    const currentTab = new URLSearchParams(window.location.search).get('tab') || 'common-events';
    document.querySelectorAll('input[name="active_tab"]').forEach(input => {
        input.value = currentTab;
    });

  // Function for loading methods from handlers
  function loadConfigMethods() {
    const configUid = document.querySelector('[data-config-uid]').dataset.configUid;
    return fetch(`/get-config-methods?config_uid=${configUid}`)
      .then(response => response.json())
      .then(data => data.methods || [])
      .catch(error => {
        console.error('Error loading config methods:', error);
        return [];
      });
  }

  function createCommonActionRow(action = {}, methods = []) {
    const row = document.createElement('div');
    row.className = 'common-action-row mb-2 p-2 border rounded';

    row.innerHTML = `
      <div class="d-flex gap-2 align-items-start">
        <div style="width:150px">
          <label class="form-label small">action</label>
          <select class="form-select common-action-field" data-field="action">
            ${ACTION_TYPES.map(a => `<option value="${a}" ${a===action.action?'selected':''}>${a}</option>`).join('')}
          </select>
        </div>
        <div style="width:220px">
          <label class="form-label small">method</label>
          <select class="form-select common-action-field" data-field="method">
            <option value="">-- {{ _('none') }} --</option>
            ${methods.map(m => `<option value="${m}" ${m===action.method?'selected':''}>${m}</option>`).join('')}
          </select>
        </div>
        <div style="width:160px">
          <label class="form-label small">postExecuteMethod</label>
          <select class="form-select common-action-field" data-field="postExecuteMethod">
            <option value="">({{ _('none') }})</option>
            ${methods.map(m => `<option value="${m}" ${m===action.postExecuteMethod?'selected':''}>${m}</option>`).join('')}
          </select>
        </div>
        <div style="width:130px">
          <label class="form-label small">source</label>
          <select class="form-select common-action-field" data-field="source">
            <option value="internal" ${action.source==='internal' || !action.source?'selected':''}>internal</option>
            <option value="external" ${action.source==='external'?'selected':''}>external</option>
          </select>
        </div>
        <div style="width:200px">
          <label class="form-label small">server</label>
          <input class="form-control common-action-field" data-field="server" value="${action.server || ''}" placeholder="{{ _('server alias') }}">
        </div>
        <div style="width:40px">
          <label class="form-label small">&nbsp;</label>
          <button type="button" class="btn btn-outline-danger btn-sm remove-common-action-btn">&times;</button>
        </div>
      </div>
    `;

    const removeBtn = row.querySelector('.remove-common-action-btn');
    removeBtn.addEventListener('click', () => row.remove());

    const sourceSelect = row.querySelector('[data-field="source"]');
    const serverInput = row.querySelector('[data-field="server"]');
    function toggleServer() {
      if (sourceSelect.value === 'external') {
        serverInput.parentElement.style.display = '';
      } else {
        serverInput.parentElement.style.display = 'none';
      }
    }
    toggleServer();
    sourceSelect.addEventListener('change', toggleServer);

    return row;
  }

  const commonActionsContainer = document.getElementById('commonActionsContainer');
  
  // Initialize the add action button
  document.getElementById('addCommonActionBtn').addEventListener('click', () => {
    loadConfigMethods().then(methods => {
      commonActionsContainer.appendChild(createCommonActionRow({}, methods));
    });
  });

  // Setting up a modal window for adding
  const addCommonEventBtn = document.querySelector('[data-bs-target="#commonEventModal"][data-bs-toggle="modal"]');
  if (addCommonEventBtn) {
    addCommonEventBtn.addEventListener('click', () => {
      document.getElementById('oldCommonEventName').value = '';
      document.getElementById('oldCommonListener').value = '';
      document.getElementById('commonEventNameSelect').value = 'onLaunch';
      document.getElementById('commonListenerInput').value = '';
      commonActionsContainer.innerHTML = '';
      
      loadConfigMethods().then(methods => {
        commonActionsContainer.appendChild(createCommonActionRow({}, methods));
      });
      
      document.getElementById('commonEventForm').action = "{{ url_for('add_config_event', config_uid=config.uid) }}";
    });
  }

  // Setting up a modal window for editing
  document.querySelectorAll('.edit-common-event-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const eventId = btn.getAttribute('data-event-id');
      const eventName = btn.getAttribute('data-event-name');
      const listener = btn.getAttribute('data-listener-name') || '';
      const actions = JSON.parse(btn.getAttribute('data-actions'));

      document.getElementById('oldCommonEventName').value = eventName;
      document.getElementById('oldCommonListener').value = listener;
      document.getElementById('commonEventNameSelect').value = eventName;
      document.getElementById('commonListenerInput').value = listener;
      commonActionsContainer.innerHTML = '';
      
      loadConfigMethods().then(methods => {
        if (actions && actions.length) {
          actions.forEach(a => commonActionsContainer.appendChild(createCommonActionRow(a, methods)));
        } else {
          commonActionsContainer.appendChild(createCommonActionRow({}, methods));
        }
      });
      
      document.getElementById('commonEventForm').action = "{{ url_for('edit_config_event', config_uid=config.uid) }}";
    });
  });

  
  // Handling form submission of common events
document.getElementById('commonEventForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const actions = [];
    document.querySelectorAll('.common-action-row').forEach(row => {
        const action = {};
        row.querySelectorAll('.common-action-field').forEach(field => {
            const key = field.getAttribute('data-field');
            action[key] = field.value;
            if (action[key] === '') delete action[key];
        });
        actions.push(action);
    });
    document.getElementById('commonActionsJson').value = JSON.stringify(actions);
    
    // Add an active tab to the form
    const activeTab = new URLSearchParams(window.location.search).get('tab') || 'common-events';
    const activeTabInput = document.createElement('input');
    activeTabInput.type = 'hidden';
    activeTabInput.name = 'active_tab';
    activeTabInput.value = activeTab;
    e.target.appendChild(activeTabInput);
    
    const formData = new FormData(e.target);
    
    fetch(e.target.action, {
        method: 'POST',
        body: formData,
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        if (response.status === 401) {
            window.location.href = "{{ url_for('index') }}";
            return;
        }
        
        const data = await response.json();
        if (data.status === "success") {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.reload();
            }
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Request failed: ' + error.message);
    });
});
});



</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('[data-config-uid]');
    if (!container) return;
    const configUid = container.dataset.configUid;

    const form = document.getElementById('aiGeneratorForm');
    if (!form) return;

    try {
    const saved = localStorage.getItem('nl_ai_provider');
    const sel = document.getElementById('aiProvider');
    if (sel && saved) sel.value = saved;
    } catch (e) {}
    
    const promptInput = document.getElementById('aiPrompt');
    const statusEl = document.getElementById('aiGeneratorStatus');
    const errorEl = document.getElementById('aiGeneratorError');

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const prompt = (promptInput.value || '').trim();
        if (!prompt) {
            alert('Enter prompt for LLM');
            return;
        }

        statusEl.textContent = 'Submitting a request to LLM...';
        errorEl.style.display = 'none';
        errorEl.textContent = '';

        const providerSelect = document.getElementById('aiProvider');
        const llm = (providerSelect && providerSelect.value) ? providerSelect.value : 'deepseek';

        // remember the choice
        try { localStorage.setItem('nl_ai_provider', llm); } catch (e) {}

        fetch(`/config/${configUid}/ai-generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, llm })
        })
        .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, data })))
        .then(({ ok, status, data }) => {
            if (!ok || data.status !== 'ok') {
                statusEl.textContent = 'Error generating configuration';
                errorEl.style.display = 'block';
                errorEl.textContent = data.message || `HTTP ${status}`;
                return;
            }

            statusEl.textContent = data.message || 'Configuration updated';
            // Reread the page to see changes in classes/handlers, etc.
            setTimeout(() => {
                const url = new URL(window.location);
                url.searchParams.set('tab', 'config');
                window.location.href = url.toString();
            }, 1000);
        })
        .catch(err => {
            statusEl.textContent = 'Request error';
            errorEl.style.display = 'block';
            errorEl.textContent = err.message;
        });
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('[data-config-uid]');
    if (!container) return;
    const configUid = container.dataset.configUid;

    const form = document.getElementById('aiGeneratorForm');
    if (!form) return;

    const promptInput = document.getElementById('aiPrompt');
    const statusEl = document.getElementById('aiGeneratorStatus');
    const errorEl = document.getElementById('aiGeneratorError');

    const layoutBtn = document.getElementById('aiGenerateLayoutBtn');
    const layoutOut = document.getElementById('aiLayoutOutput');

    if (layoutBtn && layoutOut) {
        layoutBtn.addEventListener('click', function () {
            const prompt = (promptInput.value || '').trim();
            if (!prompt) {
                alert('Enter prompt for LLM');
                return;
            }

            statusEl.textContent = 'Generating layout JSON...';
            errorEl.style.display = 'none';
            errorEl.textContent = '';

            const providerSelect = document.getElementById('aiProvider');
            const llm = (providerSelect && providerSelect.value) ? providerSelect.value : 'deepseek';

            fetch(`/config/${configUid}/ai-generate-layout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, llm })
            })
            .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, data })))
            .then(({ ok, status, data }) => {
                if (!ok || data.status !== 'ok') {
                    statusEl.textContent = 'Error generating layout';
                    errorEl.style.display = 'block';
                    errorEl.textContent = data.message || `HTTP ${status}`;
                    return;
                }

                layoutOut.value = data.layout_pretty || JSON.stringify(data.layout || [], null, 2);
                statusEl.textContent = 'Layout generated (configuration was not changed).';

                // удобно для Ctrl+C
                try { layoutOut.focus(); layoutOut.select(); } catch (e) {}
            })
            .catch(err => {
                statusEl.textContent = 'Request error';
                errorEl.style.display = 'block';
                errorEl.textContent = err.message;
            });
        });
    }
});
</script>


<style>
#qrcodeCanvas {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 5px;
    background: white;
}


.event-onlaunch {
    background-color: #6f42c1;
    color: white;
}

.event-onbarcode {
    background-color: #fd7e14;
    color: white;
}

.event-onstartmenucommand {
    background-color: #20c997;
    color: white;
}

.event-ontimer {
    background-color: #e83e8c;
    color: white;
}

.event-ondialogresult {
    background-color: #6c757d;
    color: white;
}

.event-onjsonfile {
    background-color: #17a2b8; 
    color: white;
}

.event-ontextfile {
    background-color: #28a745; 
    color: white;
}

</style>




{% endblock %}