{% extends 'client/base.html' %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="m-0">{{_('Settings')}}</h3>
  <a href="{{ url_for('client.home') }}" class="btn btn-outline-secondary btn-sm">{{_('Back')}}</a>
</div>


<div class="mb-4">
  <h5 class="card-title">{{_('Interface language')}}</h5>
  

<select id="ui-lang" class="form-select" style="max-width: 260px;">
  {% for lang_code, lang_name in LANGUAGES.items() %}
    <option value="{{ lang_code }}"
      {% if lang_code == get_locale() %}selected{% endif %}>
      {{ lang_name }}
    </option>
  {% endfor %}
</select>

</div>
<h5 class="card-title">{{_('Language')}}</h5>







<div class="card">
  <div class="card-body">
    <h5 class="card-title">{{_('Barcode scanner')}}</h5>
    <div class="text-muted small mb-3">
      {{_('External utility')}} <code>barcode_scanner_ws</code> {{_('starts a local WS-server, and the browser connects to it.')}}
    </div>

    <form method="post">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" role="switch" id="scanner_ws_enabled" name="scanner_ws_enabled" value="1" {% if scanner_ws_enabled %}checked{% endif %}>
        <label class="form-check-label" for="scanner_ws_enabled">{{_('Enable connection to scanner')}}</label>
      </div>

      <label class="form-label" for="scanner_ws_url">{{_('URL WebSocket')}}</label>
      <input class="form-control" id="scanner_ws_url" name="scanner_ws_url" value="{{ scanner_ws_url }}" placeholder="ws://127.0.0.1:8765">
      <div class="form-text">{{_('Example')}}: <code>ws://127.0.0.1:8765</code></div>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">{{_('Save')}}</button>
        <button type="button" class="btn btn-outline-secondary" id="btn-test-scanner">{{_('Check connection')}}</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const sel = document.getElementById("ui-lang");
  if(!sel) return;

  sel.addEventListener("change", () => {
    const lang = sel.value;
    // Используем существующий серверный эндпоинт
    window.location.href = "/set_language/" + encodeURIComponent(lang);
  });
})();
</script>

<script>
(function(){
  const btn = document.getElementById('btn-test-scanner');
  if(!btn) return;
  btn.addEventListener('click', async () => {
    const url = (document.getElementById('scanner_ws_url')?.value || '').trim();
    if(!url) {
      if(window.message) window.message('URL not specified', 'warning');
      return;
    }
    try {
      const ws = new WebSocket(url);
      const t = setTimeout(() => {
        try { ws.close(); } catch(_) {}
        if(window.message) window.message('No response from WebSocket (timeout)', 'danger');
      }, 1500);
      ws.onopen = () => {
        clearTimeout(t);
        try { ws.close(); } catch(_) {}
        if(window.message) window.message('WebSocket connection OK', 'success');
      };
      ws.onerror = () => {
        clearTimeout(t);
        if(window.message) window.message('WebSocket connection error', 'danger');
      };
    } catch(e) {
      if(window.message) window.message(String(e), 'danger');
    }
  });
})();
</script>
{% endblock %}
