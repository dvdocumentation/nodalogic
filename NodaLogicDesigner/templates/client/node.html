{% extends "client/base.html" %}
{% block content %}

<div class="d-flex gap-3">
  <div class="flex-grow-1">
    <div class="mb-2">
      <a id="btnBack" class="btn btn-sm btn-outline-secondary" href="{{ url_for('client.sections_home') }}">{{_('Back')}}</a>
    </div>
    <div class="mb-2">
      <span class="badge text-bg-light border">{{ repo.display_name or repo.name }}</span>
      <span class="badge text-bg-light border">{{ class_name }}</span>
    </div>

    <h4 class="mb-3">{{ node_id }}</h4>

    <div class="mb-2 text-muted small">_data</div>
    <textarea id="dataJson" class="form-control" rows="18">{{ data_json | e }}</textarea>
{{ data | tojson(indent=2) }}
</textarea>
  </div>

  {% if use_standard_commands %}
  <div style="width:260px; position:sticky; top:12px; align-self:flex-start;">
    <div class="border rounded p-2">
      <div class="d-grid gap-2">
        <button id="btnSave" class="btn btn-outline-primary" type="button">{{_('Save')}}</button>
        <button id="btnDelete" class="btn btn-danger" type="button">{{_('Delete')}}</button>
      </div>
      <div id="sideStatus" class="text-muted small mt-2"></div>
    </div>
  </div>
  {% endif %}
</div>

<script>
const apiSave = {{ url_for('client.api_node_save')|tojson }};
const apiDelete = {{ url_for('client.api_node_delete')|tojson }};

const repoId = {{ repo_id|tojson }};
const className = {{ class_name|tojson }};
const nodeId = {{ node_id|tojson }};


const backBtn = document.getElementById("btnBack");
if (backBtn) {
  backBtn.addEventListener("click", (e) => {
    try {
      const ref = document.referrer || "";
      if (ref.includes("/client/section/") || ref.includes("/client/sections")) {
        e.preventDefault();
        window.location.href = ref;
      }
    } catch(_) {}
  });
}

function setSideStatus(t){ const el=document.getElementById("sideStatus"); if(el) el.textContent = t||""; }

async function doSave(){
  let obj = {};
  try { obj = JSON.parse(document.getElementById("dataJson").value || "{}"); }
  catch(e){ alert("JSON ошибка: " + (e.message||e)); return; }

  setSideStatus("saving...");
  const r = await fetch(apiSave, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({repo_id: repoId, class_name: className, node_id: nodeId, data: obj})
  });
  const j = await r.json();
  if(!j.ok){ setSideStatus(""); alert(j.error || "save failed"); return; }
  setSideStatus("ok");
}

async function doDelete(){
  if(!confirm(`Удалить ${className}/${nodeId}?`)) return;
  setSideStatus("deleting...");
  const r = await fetch(apiDelete, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({repo_id: repoId, class_name: className, node_id: nodeId})
  });
  const j = await r.json();
  if(!j.ok){ setSideStatus(""); alert(j.error || "delete failed"); return; }
  setSideStatus("deleted");
  window.close();
}

const bS = document.getElementById("btnSave");
if(bS) bS.addEventListener("click", doSave);

const bD = document.getElementById("btnDelete");
if(bD) bD.addEventListener("click", doDelete);
</script>

{% endblock %}
